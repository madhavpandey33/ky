# This workflow will deprecate a specific version from npm registry with safety checks and confirmations
# For more information see: https://docs.npmjs.com/cli/v8/commands/npm-deprecate

name: NPM Deprecate

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package name (e.g., @mad_devx/ky)'
        required: true
        type: string
        default: '@mad_devx/ky'
      version:
        description: 'Version to deprecate (e.g., 1.1.1)'
        required: true
        type: string
      deprecation_message:
        description: 'Deprecation message (e.g., "This version has security vulnerabilities. Please upgrade to 1.1.2+")'
        required: true
        type: string
      dry_run:
        description: 'Dry run mode (true = simulate only, false = execute deprecation)'
        required: false
        type: boolean
        default: true
      confirm:
        description: 'Type "CONFIRM" to proceed with deprecation'
        required: true
        type: string

jobs:
  validate-and-confirm:
    runs-on: ubuntu-latest
    if: "github.event.inputs.confirm == 'CONFIRM'"
    
    steps:
    - uses: actions/checkout@v2
    - name: Validate confirmation input
      run: |-
        if [ "${{ github.event.inputs.confirm }}" != "CONFIRM" ]; then
          echo "âŒ Confirmation not provided. You must type 'CONFIRM' to proceed."
          exit 1
        fi
        echo "âœ… Confirmation received"
    - name: Setup Node.js environment
      uses: actions/setup-node@v1
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
    - name: Verify package exists
      run: |-
        VERSION="${{ github.event.inputs.version }}"
        PACKAGE_NAME="${{ github.event.inputs.package_name }}"
        
        echo "ðŸ” Checking if package ${PACKAGE_NAME}@${VERSION} exists..."
        
        if npm view "${PACKAGE_NAME}@${VERSION}" version 2>/dev/null; then
          echo "âœ… Package ${PACKAGE_NAME}@${VERSION} found"
        else
          echo "âŒ Package ${PACKAGE_NAME}@${VERSION} not found"
          exit 1
        fi
    - name: Display deprecation details
      run: |-
        echo "ðŸ“¦ Package: ${{ github.event.inputs.package_name }}"
        echo "ðŸ·ï¸  Version to deprecate: ${{ github.event.inputs.version }}"
        echo "ðŸ’¬ Deprecation message: ${{ github.event.inputs.deprecation_message }}"
        echo "ðŸ” Dry run mode: ${{ github.event.inputs.dry_run }}"
        echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "â° Timestamp: $(date -u)"
        echo ""
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "## ðŸ§ª DRY RUN MODE - SIMULATION ONLY"
          echo "This is a simulation. No actual changes will be made to npm registry."
        else
          echo "## âš¡ PROCEEDING WITH DEPRECATION"
          echo "The validation is complete. Proceeding automatically with deprecation."
        fi
        echo ""
        echo "âš ï¸  ${{ github.event.inputs.package_name }}@${{ github.event.inputs.version }} will be marked as deprecated!"

  deprecate-execution:
    runs-on: ubuntu-latest
    needs: [validate-and-confirm]
    
    steps:
    - uses: actions/checkout@v2
    - name: Setup Node.js environment
      uses: actions/setup-node@v1
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
    - name: Wait 5 minutes before deprecation
      run: |-
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ§ª DRY RUN MODE - Skipping 5 minute wait"
        else
          echo "â³ Waiting 5 minutes before proceeding with deprecation..."
          echo "ðŸ• Start time: $(date -u)"
          echo "âš ï¸  You have 5 minutes to cancel this workflow if needed"
          echo "ðŸ“¦ Package to deprecate: ${{ github.event.inputs.package_name }}@${{ github.event.inputs.version }}"
          echo "ðŸ’¬ Message: ${{ github.event.inputs.deprecation_message }}"
          echo "ðŸ›‘ To cancel: Go to Actions tab and cancel this workflow run"
          sleep 300
          echo "âœ… Wait period completed at: $(date -u)"
          echo "ðŸš€ Proceeding with deprecation operation..."
        fi
    - name: Execute deprecation
      run: |-
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ§ª DRY RUN MODE - SIMULATION ONLY"
        else
          echo "ðŸš¨ EXECUTING DEPRECATION"
        fi
        echo "ðŸ“¦ Package: ${{ github.event.inputs.package_name }}"
        echo "ðŸ·ï¸  Version: ${{ github.event.inputs.version }}"
        echo "ðŸ’¬ Message: ${{ github.event.inputs.deprecation_message }}"
        echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "â° Timestamp: $(date -u)"
        echo ""
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ“ Would execute: npm deprecate \"${{ github.event.inputs.package_name }}@${{ github.event.inputs.version }}\" \"${{ github.event.inputs.deprecation_message }}\""
          echo "âœ… Dry run completed successfully - no changes made"
        fi
    - name: Execute npm deprecate command
      if: ${{ github.event.inputs.dry_run == 'false' }}
      run: npm deprecate "${{ github.event.inputs.package_name }}@${{ github.event.inputs.version }}" "${{ github.event.inputs.deprecation_message }}"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.ADOBE_BOT_NPM_TOKEN }}
    - name: Verify deprecation success
      if: ${{ github.event.inputs.dry_run == 'false' }}
      run: |-
        VERSION="${{ github.event.inputs.version }}"
        PACKAGE_NAME="${{ github.event.inputs.package_name }}"
        
        echo "ðŸ” Verifying deprecation..."
        echo "â³ Waiting for npm registry to propagate changes..."
        
        # Wait a bit for npm registry to update
        sleep 10
        
        # Check if the package is marked as deprecated
        DEPRECATED_MSG=$(npm view "${PACKAGE_NAME}@${VERSION}" deprecated 2>/dev/null || echo "")
        
        if [ -n "$DEPRECATED_MSG" ]; then
          echo "âœ… Confirmed: ${PACKAGE_NAME}@${VERSION} has been deprecated"
          echo "ðŸ’¬ Deprecation message: ${DEPRECATED_MSG}"
        else
          echo "âš ï¸  Deprecation message not yet visible in npm registry"
          echo "âœ… Deprecation command executed successfully, but registry may need time to propagate"
          echo "ðŸ’¡ Try checking manually in a few minutes: npm view ${PACKAGE_NAME}@${VERSION}"
        fi

  post-deprecation:
    runs-on: ubuntu-latest
    needs: [deprecate-execution]
    if: "github.event.inputs.confirm == 'CONFIRM'"
    
    steps:
    - uses: actions/checkout@v2
    - name: Post deprecation summary
      run: |-
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "## ðŸ§ª Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ðŸ§ª Dry Run (Simulation Only)" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸ“‹ Deprecation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: âš¡ Live Execution" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Package**: ${{ github.event.inputs.package_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deprecation Message**: ${{ github.event.inputs.deprecation_message }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.dry_run }}" = "false" ]; then
          echo "- **Status**: âœ… Successfully deprecated" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âœ… Dry run completed - no changes made" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ§ª **Dry Run Mode**: This was a simulation only. No actual changes were made to npm registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To execute for real, run the workflow again with \`dry_run: false\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Important**: Users installing this version will see the deprecation warning." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor dependent projects for migration" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure a recommended replacement version exists" >> $GITHUB_STEP_SUMMARY
          echo "- Update documentation to reflect the deprecation" >> $GITHUB_STEP_SUMMARY
          echo "- Consider un-deprecating later if needed: \`npm deprecate <pkg>@<version> \"\"\`" >> $GITHUB_STEP_SUMMARY
        fi
